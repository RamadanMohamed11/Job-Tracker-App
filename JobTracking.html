<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job &amp; Portfolio Tracker</title> <!-- Updated Title -->
    
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 3. Chart.js for Analytics (lazy-loaded when needed) -->

    <!-- 4. Custom Styles & Animations -->
    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Page load fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        body {
            animation: fadeIn 0.8s ease-in-out;
        }

        /* Form input focus animation */
        input:focus, select:focus, textarea:focus {
            transform: scale(1.02);
            transition: transform 0.2s ease;
        }

        /* Card entrance animation */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>

    <!-- 5. Dark Mode immediate script (prevents flash) -->
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header: Title, Nav, + Dark Mode Toggle -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400">
                Job &amp; Portfolio Tracker
            </h1>

            <!-- Navigation -->
            <nav class="flex gap-2 p-1 bg-gray-200 dark:bg-gray-700 rounded-lg">
                <button id="nav-dashboard" class="py-2 px-4 rounded-md font-semibold text-sm transition-all">
                    Jobs
                </button>
                <button id="nav-portfolio" class="py-2 px-4 rounded-md font-semibold text-sm transition-all">
                    Portfolio
                </button>
                <button id="nav-analytics" class="py-2 px-4 rounded-md font-semibold text-sm transition-all">
                    Analytics
                </button>
            </nav>

            <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-300">
                <!-- Sun Icon (Light Mode) -->
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <!-- Moon Icon (Dark Mode) -->
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </header>

        <!-- Main Content: Pages will be toggled via JS -->
        <main>

            <!-- Page 1: Job Form Section -->
            <section id="page-form" class="hidden">
                <form id="job-form" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-6" id="form-title">Add New Application</h2>
                    
                    <!-- Hidden input to store ID for editing -->
                    <input type="hidden" id="edit-id">

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Company Name -->
                        <div class="sm:col-span-2">
                            <label for="company-name" class="block text-sm font-medium mb-1">Company Name *</label>
                            <input type="text" id="company-name" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all" required>
                        </div>

                        <!-- Job Title -->
                        <div class="sm:col-span-2">
                            <label for="job-title" class="block text-sm font-medium mb-1">Job Title *</label>
                            <input type="text" id="job-title" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all" required>
                        </div>

                        <!-- Application Date -->
                        <div>
                            <label for="app-date" class="block text-sm font-medium mb-1">Application Date *</label>
                            <input type="date" id="app-date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all" required>
                        </div>

                        <!-- Application Status -->
                        <div>
                            <label for="app-status" class="block text-sm font-medium mb-1">Status *</label>
                            <select id="app-status" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all" required>
                                <option value="Submitted">Submitted</option>
                                <option value="Under review">Under review</option>
                                <option value="Interview scheduled">Interview scheduled</option>
                                <option value="Interviewed">Interviewed</option>
                                <option value="Assessment">Assessment</option>
                                <option value="Offer">Offer</option>
                                <option value="Accepted">Accepted</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Withdrawn">Withdrawn</option>
                                <option value="On hold">On hold</option>
                            </select>
                        </div>

                        <!-- Contact Person -->
                        <div>
                            <label for="contact-person" class="block text-sm font-medium mb-1">Contact Person</label>
                            <input type="text" id="contact-person" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>

                        <!-- Contact Email -->
                        <div>
                            <label for="contact-email" class="block text-sm font-medium mb-1">Contact Email</label>
                            <input type="email" id="contact-email" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>

                        <!-- Follow-up Date -->
                        <div>
                            <label for="follow-up-date" class="block text-sm font-medium mb-1">Follow-up Date</label>
                            <input type="date" id="follow-up-date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>

                        <!-- Source -->
                        <div>
                            <label for="source" class="block text-sm font-medium mb-1">Source</label>
                            <select id="source" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all">
                                <option value="LinkedIn">LinkedIn</option>
                                <option value="WUZZUF">WUZZUF</option>
                                <option value="Bayt.com">Bayt.com</option>
                                <option value="We Work Remotely">We Work Remotely</option>
                                <option value="Company site">Company site</option>
                                <option value="Referral">Referral</option>
                                <option value="Recruiter outreach">Recruiter outreach</option>
                                <option value="Indeed">Indeed</option>
                                <option value="GitHub Jobs">GitHub Jobs</option>
                                <option value="Stack Overflow Jobs">Stack Overflow Jobs</option>
                                <option value="Twitter/X">Twitter/X</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Job Role Type -->
                        <div class="sm:col-span-2">
                            <label for="role-type" class="block text-sm font-medium mb-1">Role Type</label>
                            <select id="role-type" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all">
                                <option value="Other">Other</option>
                                <option value="Flutter">Flutter</option>
                                <option value="Embedded">Embedded</option>
                                <option value="Control">Control</option>
                            </select>
                        </div>
                    </div>

                    <!-- Job URL -->
                    <div class="mt-4">
                        <label for="job-url" class="block text-sm font-medium mb-1">Job URL</label>
                        <input type="url" id="job-url" placeholder="https://..." pattern="https?://.*" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>

                    <!-- Notes -->
                    <div class="mt-4">
                        <label for="notes" class="block text-sm font-medium mb-1">Notes</label>
                        <textarea id="notes" rows="4" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-6 grid grid-cols-2 gap-4">
                        <button type="button" id="clear-btn" class="w-full bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-100 py-2 px-4 rounded-md font-semibold hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-300 active:scale-95">
                            Clear
                        </button>
                        <button type="submit" id="save-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition-all duration-300 active:scale-95">
                            Save Application
                        </button>
                    </div>
                </form>
            </section>

            <!-- Page 2: Application List Section (Job Dashboard) -->
            <section id="page-dashboard" class="hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-semibold">Job Applications</h2>
                    <button id="btn-show-form" class="w-full sm:w-auto bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition-all duration-300 active:scale-95 text-sm">
                        + Add New Job
                    </button>
                </div>
                
                <!-- Dashboard Controls: Filter & Sort -->
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <!-- Filter by Status -->
                    <div class="flex-1">
                        <label for="filter-status" class="block text-sm font-medium mb-1">Filter by Status</label>
                        <select id="filter-status" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 transition-all">
                            <option value="all">All Statuses</option>
                            <option value="Submitted">Submitted</option>
                            <option value="Under review">Under review</option>
                            <option value="Interview scheduled">Interview scheduled</option>
                            <option value="Interviewed">Interviewed</option>
                            <option value="Assessment">Assessment</option>
                            <option value="Offer">Offer</option>
                            <option value="Accepted">Accepted</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Withdrawn">Withdrawn</option>
                            <option value="On hold">On hold</option>
                        </select>
                    </div>
                    <!-- Sort by -->
                    <div class="flex-1">
                        <label for="sort-by" class="block text-sm font-medium mb-1">Sort By</label>
                        <select id="sort-by" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 transition-all">
                            <option value="date-new">Newest First</option>
                            <option value="date-old">Oldest First</option>
                            <option value="company-az">Company (A-Z)</option>
                            <option value="company-za">Company (Z-A)</option>
                        </select>
                    </div>
                </div>

                <!-- Date Range Filters -->
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <div class="flex-1">
                        <label for="filter-date-start" class="block text-sm font-medium mb-1">From Date</label>
                        <input type="date" id="filter-date-start" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                    <div class="flex-1">
                        <label for="filter-date-end" class="block text-sm font-medium mb-1">To Date</label>
                        <input type="date" id="filter-date-end" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                </div>

                <!-- Search -->
                <div class="mb-4">
                    <input type="text" id="search-bar" placeholder="Search by company or title..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 transition-all">
                </div>

                <!-- Results Count -->
                <div class="mb-4">
                    <p id="jobs-count" class="text-sm font-medium text-gray-700 dark:text-gray-300">Showing 0 applications</p>
                </div>

                <div id="application-list" class="space-y-4">
                    <!-- Job cards will be dynamically inserted here -->
                </div>
                <p id="empty-state" class="hidden text-center text-gray-500 dark:text-gray-400 mt-12">
                    No applications found.
                </p>
            </section>

            <!-- Page 3: Analytics Section -->
            <section id="page-analytics" class="hidden">
                <!-- Date Range Filters -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="analytics-start-date" class="block text-sm font-medium mb-1">Start Date</label>
                            <input type="date" id="analytics-start-date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-yellow-500 transition-all">
                        </div>
                        <div>
                            <label for="analytics-end-date" class="block text-sm font-medium mb-1">End Date</label>
                            <input type="date" id="analytics-end-date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-yellow-500 transition-all">
                        </div>
                    </div>
                    <p id="analytics-date-error" class="hidden text-sm text-red-500 mt-3">Start date must be on or before the end date.</p>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Total Applications Card -->
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 p-6 rounded-lg shadow-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium opacity-90">Total Applications</p>
                                <p id="summary-total-apps" class="text-3xl font-bold mt-2">0</p>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                    </div>

                    <!-- Active Projects Card -->
                    <div class="bg-gradient-to-br from-green-500 to-green-600 dark:from-green-600 dark:to-green-700 p-6 rounded-lg shadow-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium opacity-90">Active Projects</p>
                                <p id="summary-active-projects" class="text-3xl font-bold mt-2">0</p>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                    </div>

                    <!-- Total Income Card -->
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 dark:from-yellow-600 dark:to-yellow-700 p-6 rounded-lg shadow-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium opacity-90">Total Income</p>
                                <p id="summary-total-income-egp" class="text-3xl font-bold mt-2">EGP 0</p>
                                <p id="summary-total-income-usd" class="text-lg font-medium opacity-90 mt-1">$0 USD</p>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>

                    <!-- Conversion Rate Card -->
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 dark:from-purple-600 dark:to-purple-700 p-6 rounded-lg shadow-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium opacity-90">Offer Conversion</p>
                                <p id="summary-conversion-rate" class="text-3xl font-bold mt-2">0%</p>
                                <p id="summary-offer-count" class="text-lg font-medium opacity-90 mt-1">0 offers</p>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Job Analytics -->
                <h2 class="text-2xl font-semibold mb-6">Job Application Analytics</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                    <!-- Chart 1: By Status -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Applications by Status</h3>
                        <div class="relative h-64 sm:h-80">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 2: By Source -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Applications by Source</h3>
                        <div class="relative h-64 sm:h-80">
                            <canvas id="sourceChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 3: Over Time -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-4">Applications Over Time (by month)</h3>
                        <div class="relative h-64 sm:h-80">
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Freelance Analytics (NEW) -->
                <h2 class="text-2xl font-semibold mb-6">Freelance Analytics</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Chart 4: Freelance Income Over Time -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-4">Freelance Income Over Time (by month)</h3>
                        <div class="relative h-64 sm:h-80">
                            <canvas id="freelanceIncomeChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 5: Freelance by Status -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Projects by Status</h3>
                        <div class="relative h-64 sm:h-80">
                            <canvas id="freelanceStatusChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 6: Freelance by Role -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Projects by Role</h3>
                        <div class="relative h-64 sm:h-80">
                            <canvas id="freelanceRoleChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Page 4: Freelance Portfolio Section (NEW) -->
            <section id="page-portfolio" class="hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-semibold">Freelance Portfolio</h2>
                    <button id="btn-show-project-form" class="w-full sm:w-auto bg-green-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-700 transition-all duration-300 active:scale-95 text-sm">
                        + Add New Project
                    </button>
                </div>
                
                <!-- Portfolio Controls: Filter & Sort -->
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <!-- Filter by Status -->
                    <div class="flex-1">
                        <label for="filter-project-status" class="block text-sm font-medium mb-1">Filter by Status</label>
                        <select id="filter-project-status" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-green-500 transition-all">
                            <option value="all">All Statuses</option>
                            <option value="Planning">Planning</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <!-- Sort by -->
                    <div class="flex-1">
                        <label for="sort-project-by" class="block text-sm font-medium mb-1">Sort By</label>
                        <select id="sort-project-by" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-green-500 transition-all">
                            <option value="date-new">Newest First</option>
                            <option value="date-old">Oldest First</option>
                            <option value="price-high">Price (High-Low)</option>
                            <option value="price-low">Price (Low-High)</option>
                            <option value="client-az">Client (A-Z)</option>
                        </select>
                    </div>
                </div>

                <!-- Date Range Filters -->
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <div class="flex-1">
                        <label for="filter-project-date-start" class="block text-sm font-medium mb-1">From Date</label>
                        <input type="date" id="filter-project-date-start" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-green-500 transition-all">
                    </div>
                    <div class="flex-1">
                        <label for="filter-project-date-end" class="block text-sm font-medium mb-1">To Date</label>
                        <input type="date" id="filter-project-date-end" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-green-500 transition-all">
                    </div>
                </div>

                <!-- Search -->
                <div class="mb-4">
                    <input type="text" id="search-project-bar" placeholder="Search by project or client..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-green-500 transition-all">
                </div>

                <!-- Results Count -->
                <div class="mb-4">
                    <p id="projects-count" class="text-sm font-medium text-gray-700 dark:text-gray-300">Showing 0 projects</p>
                </div>

                <div id="portfolio-list" class="space-y-4">
                    <!-- Project cards will be dynamically inserted here -->
                </div>
                <p id="portfolio-empty-state" class="hidden text-center text-gray-500 dark:text-gray-400 mt-12">
                    No projects found.
                </p>
            </section>

            <!-- Page 5: Project Form Section (NEW) -->
            <section id="page-project-form" class="hidden">
                <form id="project-form" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-6" id="project-form-title">Add New Project</h2>
                    
                    <input type="hidden" id="edit-project-id">

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Project Name -->
                        <div class="sm:col-span-2">
                            <label for="project-name" class="block text-sm font-medium mb-1">Project Name *</label>
                            <input type="text" id="project-name" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 transition-all" required>
                        </div>

                        <!-- Client Name -->
                        <div>
                            <label for="client-name" class="block text-sm font-medium mb-1">Client Name</label>
                            <input type="text" id="client-name" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 transition-all">
                        </div>

                        <!-- Project Date (e.g., End Date) -->
                        <div>
                            <label for="project-date" class="block text-sm font-medium mb-1">Date *</label>
                            <input type="date" id="project-date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 transition-all" required>
                        </div>

                        <!-- Price (EGP) -->
                        <div>
                            <label for="project-price-egp" class="block text-sm font-medium mb-1">Price (EGP)</label>
                            <input type="number" id="project-price-egp" placeholder="e.g., 30000" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 transition-all">
                        </div>

                        <!-- Price (USD) -->
                        <div>
                            <label for="project-price-usd" class="block text-sm font-medium mb-1">Price (USD - at time of work)</label>
                            <input type="number" id="project-price-usd" placeholder="e.g., 1000" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 transition-all">
                        </div>

                        <!-- Project Status -->
                        <div>
                            <label for="project-status" class="block text-sm font-medium mb-1">Status *</label>
                            <select id="project-status" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 transition-all" required>
                                <option value="Planning">Planning</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>

                        <!-- Project Role Type -->
                        <div class="sm:col-span-2">
                            <label for="project-role-type" class="block text-sm font-medium mb-1">Role Type</label>
                            <select id="project-role-type" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 transition-all">
                                <option value="Other">Other</option>
                                <option value="Flutter">Flutter</option>
                                <option value="Embedded">Embedded</option>
                                <option value="Web">Web</option>
                            </select>
                        </div>
                    </div>

                    <!-- Project URL -->
                    <div class="mt-4">
                        <label for="project-url" class="block text-sm font-medium mb-1">Project URL (Repo, Website)</label>
                        <input type="url" id="project-url" placeholder="https://..." pattern="https?://.*" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 transition-all">
                    </div>

                    <!-- Project Notes -->
                    <div class="mt-4">
                        <label for="project-notes" class="block text-sm font-medium mb-1">Notes</label>
                        <textarea id="project-notes" rows="4" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-2 focus:ring-green-500 transition-all"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-6 grid grid-cols-2 gap-4">
                        <button type="button" id="project-clear-btn" class="w-full bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-100 py-2 px-4 rounded-md font-semibold hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-300 active:scale-95">
                            Clear
                        </button>
                        <button type="submit" id="project-save-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-700 transition-all duration-300 active:scale-95">
                            Save Project
                        </button>
                    </div>
                </form>
            </section>

        </main>
    </div>

    <!-- JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Element Selectors ---
            const themeToggle = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');

            // Page Navigation Elements
            const navDashboard = document.getElementById('nav-dashboard');
            const navPortfolio = document.getElementById('nav-portfolio'); // Updated
            const navAnalytics = document.getElementById('nav-analytics');
            // const navAdd = document.getElementById('nav-add'); // Removed
            const pageForm = document.getElementById('page-form');
            const pageDashboard = document.getElementById('page-dashboard');
            const pageAnalytics = document.getElementById('page-analytics');
            const pagePortfolio = document.getElementById('page-portfolio'); // New
            const pageProjectForm = document.getElementById('page-project-form'); // New
            const btnShowForm = document.getElementById('btn-show-form');
            const btnShowProjectForm = document.getElementById('btn-show-project-form'); // New

            // Job Form
            const jobForm = document.getElementById('job-form');
            const formTitle = document.getElementById('form-title');
            const saveBtn = document.getElementById('save-btn');
            const clearBtn = document.getElementById('clear-btn');
            
            // Job Dashboard
            const applicationList = document.getElementById('application-list');
            const searchBar = document.getElementById('search-bar');
            const emptyState = document.getElementById('empty-state');
            const filterStatusInput = document.getElementById('filter-status');
            const sortByInput = document.getElementById('sort-by');
            const filterDateStartInput = document.getElementById('filter-date-start');
            const filterDateEndInput = document.getElementById('filter-date-end');
            const jobsCountDisplay = document.getElementById('jobs-count');
            
            // Job Form Fields
            const editIdInput = document.getElementById('edit-id');
            const companyNameInput = document.getElementById('company-name');
            const jobTitleInput = document.getElementById('job-title');
            const appDateInput = document.getElementById('app-date');
            const appStatusInput = document.getElementById('app-status');
            const contactPersonInput = document.getElementById('contact-person');
            const contactEmailInput = document.getElementById('contact-email');
            const followUpDateInput = document.getElementById('follow-up-date');
            const sourceInput = document.getElementById('source');
            const roleTypeInput = document.getElementById('role-type');
            const jobUrlInput = document.getElementById('job-url');
            const notesInput = document.getElementById('notes');

            // New Project Form
            const projectForm = document.getElementById('project-form');
            const projectFormTitle = document.getElementById('project-form-title');
            const projectSaveBtn = document.getElementById('project-save-btn');
            const projectClearBtn = document.getElementById('project-clear-btn');

            // New Project Dashboard
            const portfolioList = document.getElementById('portfolio-list');
            const searchProjectBar = document.getElementById('search-project-bar');
            const portfolioEmptyState = document.getElementById('portfolio-empty-state');
            const filterProjectStatusInput = document.getElementById('filter-project-status');
            const sortProjectByInput = document.getElementById('sort-project-by');
            const filterProjectDateStartInput = document.getElementById('filter-project-date-start');
            const filterProjectDateEndInput = document.getElementById('filter-project-date-end');
            const projectsCountDisplay = document.getElementById('projects-count');

            // New Project Form Fields
            const editProjectIdInput = document.getElementById('edit-project-id');
            const projectNameInput = document.getElementById('project-name');
            const clientNameInput = document.getElementById('client-name');
            const projectDateInput = document.getElementById('project-date');
            const projectStatusInput = document.getElementById('project-status');
            const projectPriceEgpInput = document.getElementById('project-price-egp'); // Updated
            const projectPriceUsdInput = document.getElementById('project-price-usd'); // New
            const projectRoleTypeInput = document.getElementById('project-role-type');
            const projectUrlInput = document.getElementById('project-url');
            const projectNotesInput = document.getElementById('project-notes');

            // Analytics Filters & Summary Elements
            const analyticsStartInput = document.getElementById('analytics-start-date');
            const analyticsEndInput = document.getElementById('analytics-end-date');
            const analyticsDateError = document.getElementById('analytics-date-error');
            const summaryConversionRate = document.getElementById('summary-conversion-rate');
            const summaryOfferCount = document.getElementById('summary-offer-count');

            // Chart Instance Variables
            let statusChartInstance = null;
            let sourceChartInstance = null;
            let timeChartInstance = null;
            let freelanceIncomeChartInstance = null; // New
            let freelanceStatusChartInstance = null; // New
            let freelanceRoleChartInstance = null; // New

            const ensureChartJs = (() => {
                let chartJsPromise = null;
                return () => {
                    if (window.Chart) {
                        return Promise.resolve();
                    }
                    if (!chartJsPromise) {
                        chartJsPromise = new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                            script.onload = resolve;
                            script.onerror = () => {
                                chartJsPromise = null;
                                console.error('Failed to load Chart.js');
                                reject(new Error('Failed to load Chart.js'));
                            };
                            document.head.appendChild(script);
                        });
                    }
                    return chartJsPromise;
                };
            })();

            const getTodayIso = () => new Date().toISOString().split('T')[0];

            const setDateMaxValues = () => {
                const todayIso = getTodayIso();
                if (appDateInput) appDateInput.setAttribute('max', todayIso);
                if (projectDateInput) projectDateInput.setAttribute('max', todayIso);
                if (analyticsStartInput) analyticsStartInput.setAttribute('max', todayIso);
                if (analyticsEndInput) analyticsEndInput.setAttribute('max', todayIso);
            };

            setDateMaxValues();

            const STORAGE_KEY = 'jobApplications';
            const PORTFOLIO_KEY = 'freelanceProjects'; // New

            // --- Dark Mode Logic ---
            const updateThemeIcons = () => {
                if (document.documentElement.classList.contains('dark')) {
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                } else {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
            };
            
            // --- FIX: Added missing theme logic ---
            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateThemeIcons();
                // Re-render charts if on analytics page
                if (!pageAnalytics.classList.contains('hidden')) {
                    ensureChartJs().then(() => {
                        renderAnalytics();
                    }).catch(() => {
                        // Already logged inside ensureChartJs
                    });
                }
            });

            updateThemeIcons(); // Set icons on initial load
            // --- End of FIX ---
            
            
            // --- FIX: Added missing Page Navigation Logic ---
            const showPage = (pageName) => {
                setDateMaxValues();
                // Hide all pages
                pageForm.classList.add('hidden');
                pageDashboard.classList.add('hidden');
                pageAnalytics.classList.add('hidden');
                pagePortfolio.classList.add('hidden'); // New
                pageProjectForm.classList.add('hidden'); // New

                // Reset nav button styles
                navDashboard.classList.remove('bg-white', 'dark:bg-gray-900', 'text-blue-600', 'dark:text-blue-400');
                navPortfolio.classList.remove('bg-white', 'dark:bg-gray-900', 'text-green-600', 'dark:text-green-400'); // New
                navAnalytics.classList.remove('bg-white', 'dark:bg-gray-900', 'text-yellow-600', 'dark:text-yellow-400');

                if (pageName === 'form') {
                    // Show Job Form
                    pageForm.classList.remove('hidden');
                    // No nav button to highlight, it's a sub-page of 'Jobs'
                    navDashboard.classList.add('bg-white', 'dark:bg-gray-900', 'text-blue-600', 'dark:text-blue-400');
                } else if (pageName === 'project-form') {
                    // Show Project Form
                    pageProjectForm.classList.remove('hidden');
                    // No nav button to highlight, it's a sub-page of 'Portfolio'
                    navPortfolio.classList.add('bg-white', 'dark:bg-gray-900', 'text-green-600', 'dark:text-green-400');
                } else if (pageName === 'analytics') {
                    // Show Analytics
                    pageAnalytics.classList.remove('hidden');
                    navAnalytics.classList.add('bg-white', 'dark:bg-gray-900', 'text-yellow-600', 'dark:text-yellow-400');
                    ensureChartJs().then(() => {
                        renderAnalytics(); // Render charts when page is shown
                    }).catch(() => {
                        // Error already logged in ensureChartJs
                    });
                } else if (pageName === 'portfolio') {
                    // Show Portfolio
                    pagePortfolio.classList.remove('hidden');
                    navPortfolio.classList.add('bg-white', 'dark:bg-gray-900', 'text-green-600', 'dark:text-green-400');
                    renderPortfolio(); 
                } else {
                    // Show Job Dashboard (default)
                    pageDashboard.classList.remove('hidden');
                    navDashboard.classList.add('bg-white', 'dark:bg-gray-900', 'text-blue-600', 'dark:text-blue-400');
                    renderApplications(); // Re-render list just in case
                }
            };

            navDashboard.addEventListener('click', () => showPage('dashboard'));
            navPortfolio.addEventListener('click', () => showPage('portfolio')); // Updated
            navAnalytics.addEventListener('click', () => showPage('analytics'));
            
            btnShowForm.addEventListener('click', () => {
                resetForm(); // Clear form for new entry
                showPage('form');
            });
            btnShowProjectForm.addEventListener('click', () => { // New
                resetProjectForm(); 
                showPage('project-form');
            });
            // --- End of FIX ---


            // --- Local Storage Functions ---
            const getApplications = () => {
                return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            };

            const saveApplications = (apps) => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(apps));
            };

            // New Portfolio Storage Functions
            const getProjects = () => {
                return JSON.parse(localStorage.getItem(PORTFOLIO_KEY)) || [];
            };

            const saveProjects = (projects) => {
                localStorage.setItem(PORTFOLIO_KEY, JSON.stringify(projects));
            };

            // --- Helper Functions ---
            
            // New Date Formatting Helper
            const formatDateDDMMYYYY = (dateString) => {
                if (!dateString) return '';
                try {
                    const [year, month, day] = dateString.split('-');
                    if (!year || !month || !day) return dateString; // Return original if not yyyy-mm-dd
                    return `${day}/${month}/${year}`;
                } catch (e) {
                    return dateString; // Fallback
                }
            };
            
            const getStatusColor = (status) => {
                switch (status) {
                    case 'Submitted':
                    case 'Under review':
                        return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                    case 'Interview scheduled':
                    case 'Interviewed':
                    case 'Assessment':
                        return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    case 'Offer':
                    case 'Accepted':
                        return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                    case 'Rejected':
                    case 'Withdrawn':
                        return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                    case 'On hold':
                        return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
                    default:
                        return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
                }
            };

            // New Project Status Color Helper
            const getProjectStatusColor = (status) => {
                switch (status) {
                    case 'Planning':
                        return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
                    case 'In Progress':
                        return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                    case 'Completed':
                        return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                    case 'On Hold':
                        return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    case 'Cancelled':
                        return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                    default:
                        return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
                }
            };
            
            // Updated Role Color Helper
            const getRoleColor = (role) => {
                switch (role) {
                    case 'Flutter':
                        return 'bg-sky-100 text-sky-800 dark:bg-sky-900 dark:text-sky-200';
                    case 'Embedded':
                        return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                    case 'Control':
                        return 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200';
                    case 'Web':
                        return 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';
                    default:
                        return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
                }
            };

            const escapeHTML = (str) => {
                if (!str) return '';
                return str.replace(/[&<>"']/g, (match) => {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[match];
                });
            };

            const getAnalyticsDateFilters = () => {
                if (!analyticsStartInput || !analyticsEndInput) {
                    return { startDate: null, endDate: null, hasFilter: false, invalid: false };
                }

                const startValue = analyticsStartInput.value;
                const endValue = analyticsEndInput.value;

                const startDate = startValue ? new Date(startValue) : null;
                const endDate = endValue ? new Date(endValue) : null;

                if (endDate) {
                    endDate.setHours(23, 59, 59, 999);
                }

                const invalid = Boolean(startDate && endDate && startDate > endDate);
                if (analyticsDateError) {
                    analyticsDateError.classList.toggle('hidden', !invalid);
                }

                return {
                    startDate,
                    endDate,
                    hasFilter: Boolean(startDate || endDate),
                    invalid,
                };
            };

            const filterItemsByDateRange = (items, getDateValue, startDate, endDate, hasFilter) => {
                if (!hasFilter) {
                    return items;
                }

                return items.filter((item) => {
                    const dateStr = getDateValue(item);
                    if (!dateStr) {
                        return false;
                    }
                    const date = new Date(dateStr);
                    if (Number.isNaN(date.getTime())) {
                        return false;
                    }
                    if (startDate && date < startDate) {
                        return false;
                    }
                    if (endDate && date > endDate) {
                        return false;
                    }
                    return true;
                });
            };

            // --- Render Function (Job Dashboard) ---
            const renderApplications = () => {
                let processedApps = getApplications();
                const searchTerm = searchBar.value.toLowerCase();
                const filterValue = filterStatusInput.value;
                const sortValue = sortByInput.value;
                const dateStart = filterDateStartInput ? filterDateStartInput.value : '';
                const dateEnd = filterDateEndInput ? filterDateEndInput.value : '';

                // 1. Filter by Status
                if (filterValue !== 'all') {
                    processedApps = processedApps.filter(app => app.status === filterValue);
                }

                // 1a. Filter by Date Range
                if (dateStart) {
                    processedApps = processedApps.filter(app => app.appDate >= dateStart);
                }
                if (dateEnd) {
                    processedApps = processedApps.filter(app => app.appDate <= dateEnd);
                }

                // 2. Sort
                processedApps.sort((a, b) => {
                    switch (sortValue) {
                        case 'date-new':
                            return new Date(b.appDate) - new Date(a.appDate);
                        case 'date-old':
                            return new Date(a.appDate) - new Date(b.appDate);
                        case 'company-az':
                            return a.company.localeCompare(b.company);
                        case 'company-za':
                            return b.company.localeCompare(a.company);
                        default:
                            return new Date(b.appDate) - new Date(a.appDate);
                    }
                });
                
                // 3. Filter by Search Term
                if (searchTerm) {
                    processedApps = processedApps.filter(app => 
                        app.company.toLowerCase().includes(searchTerm) ||
                        app.title.toLowerCase().includes(searchTerm)
                    );
                }

                applicationList.innerHTML = ''; // Clear list

                // Update count display
                if (jobsCountDisplay) {
                    const count = processedApps.length;
                    jobsCountDisplay.textContent = `Showing ${count} application${count !== 1 ? 's' : ''}`;
                }

                if (processedApps.length === 0) {
                    emptyState.classList.remove('hidden');
                    emptyState.textContent = 'No applications found.';
                } else {
                    emptyState.classList.add('hidden');
                }

                processedApps.forEach(app => {
                    const card = document.createElement('div');
                    card.className = 'job-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all duration-300';
                    card.style.animation = 'slideInUp 0.5s ease-out';
                    
                    const notesHTML = app.notes ? `
                        <div class="mb-4 mt-2">
                            <p class="font-medium text-sm">Notes:</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-wrap">${escapeHTML(app.notes)}</p>
                        </div>
                    ` : '';
                    
                    const contactHTML = app.contactPerson || app.contactEmail ?
                        `<p><strong>Contact:</strong> ${escapeHTML(app.contactPerson) || ''} ${app.contactEmail ? `(${escapeHTML(app.contactEmail)})` : ''}</p>` : '';
                    
                    const followUpHTML = app.followUpDate ? `<p><strong>Follow-up:</strong> ${escapeHTML(formatDateDDMMYYYY(app.followUpDate))}</p>` : ''; // Updated format
                    const sourceHTML = app.source ? `<p><strong>Source:</strong> ${escapeHTML(app.source)}</p>` : '';
                    
                    let urlButton = '';
                    if (app.jobUrl) {
                        let properUrl = app.jobUrl;
                        if (!properUrl.startsWith('http://') && !properUrl.startsWith('https://')) {
                            properUrl = 'https://' + properUrl;
                        }
                        const safeUrl = properUrl.replace(/"/g, '&quot;');
                        
                        urlButton = `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="py-1 px-3 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition-all">View Job</a>`;
                    }
                    
                    const roleTag = app.roleType ? `<span class="py-1 px-3 rounded-full text-sm font-medium ${getRoleColor(app.roleType)}">${escapeHTML(app.roleType)}</span>` : '';

                    card.innerHTML = `
                        <div class="flex flex-wrap justify-between items-start gap-2 mb-2">
                            <div>
                                <h3 class="text-xl font-bold text-blue-600 dark:text-blue-400">${escapeHTML(app.title)}</h3>
                                <p class="text-lg text-gray-700 dark:text-gray-300">${escapeHTML(app.company)}</p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 items-end sm:items-center">
                                ${roleTag}
                                <span class="py-1 px-3 rounded-full text-sm font-medium ${getStatusColor(app.status)}">${escapeHTML(app.status)}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-600 dark:text-gray-400 mb-2">
                            <p><strong>Applied:</strong> ${escapeHTML(formatDateDDMMYYYY(app.appDate))}</p> <!-- Updated format -->
                            ${followUpHTML}
                            ${contactHTML}
                            ${sourceHTML}
                        </div>
                        ${notesHTML}
                        <div class="flex flex-wrap gap-3 items-center mt-4">
                            ${urlButton}
                            <button class="edit-btn py-1 px-3 bg-yellow-500 text-white rounded-md text-sm hover:bg-yellow-600 transition-all" data-id="${app.id}">Edit</button>
                            <button class="delete-btn py-1 px-3 bg-red-500 text-white rounded-md text-sm hover:bg-red-600 transition-all" data-id="${app.id}">Delete</button>
                        </div>
                    `;
                    applicationList.appendChild(card);
                });
            };

            // --- NEW Render Function (Portfolio Dashboard) ---
            const renderPortfolio = () => {
                let processedProjects = getProjects();
                const searchTerm = searchProjectBar.value.toLowerCase();
                const filterValue = filterProjectStatusInput.value;
                const sortValue = sortProjectByInput.value;
                const dateStart = filterProjectDateStartInput ? filterProjectDateStartInput.value : '';
                const dateEnd = filterProjectDateEndInput ? filterProjectDateEndInput.value : '';

                // 1. Filter by Status
                if (filterValue !== 'all') {
                    processedProjects = processedProjects.filter(p => p.status === filterValue);
                }

                // 1a. Filter by Date Range
                if (dateStart) {
                    processedProjects = processedProjects.filter(p => p.date >= dateStart);
                }
                if (dateEnd) {
                    processedProjects = processedProjects.filter(p => p.date <= dateEnd);
                }

                // 2. Sort
                processedProjects.sort((a, b) => {
                    switch (sortValue) {
                        case 'date-new':
                            return new Date(b.date) - new Date(a.date);
                        case 'date-old':
                            return new Date(a.date) - new Date(b.date);
                        case 'price-high':
                            return (parseFloat(b.priceUSD) || 0) - (parseFloat(a.priceUSD) || 0); // Sort by USD
                        case 'price-low':
                            return (parseFloat(a.priceUSD) || 0) - (parseFloat(b.priceUSD) || 0); // Sort by USD
                        case 'client-az':
                            return (a.client || '').localeCompare(b.client || '');
                        default:
                            return new Date(b.date) - new Date(a.date);
                    }
                });
                
                // 3. Filter by Search Term
                if (searchTerm) {
                    processedProjects = processedProjects.filter(p => 
                        (p.name || '').toLowerCase().includes(searchTerm) ||
                        (p.client || '').toLowerCase().includes(searchTerm)
                    );
                }

                portfolioList.innerHTML = ''; // Clear list

                // Update count display
                if (projectsCountDisplay) {
                    const count = processedProjects.length;
                    projectsCountDisplay.textContent = `Showing ${count} project${count !== 1 ? 's' : ''}`;
                }

                if (processedProjects.length === 0) {
                    portfolioEmptyState.classList.remove('hidden');
                } else {
                    portfolioEmptyState.classList.add('hidden');
                }

                processedProjects.forEach(project => {
                    const card = document.createElement('div');
                    card.className = 'job-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all duration-300';
                    card.style.animation = 'slideInUp 0.5s ease-out';
                    
                    const notesHTML = project.notes ? `
                        <div class="mb-4 mt-2">
                            <p class="font-medium text-sm">Notes:</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-wrap">${escapeHTML(project.notes)}</p>
                        </div>
                    ` : '';
                    
                    const clientHTML = project.client ? `<p class="text-lg text-gray-700 dark:text-gray-300">Client: ${escapeHTML(project.client)}</p>` : '';
                    
                    // Updated Price HTML
                    let priceHTML = '';
                    if (project.priceEGP) {
                        priceHTML += `<p class="text-2xl font-bold text-green-600 dark:text-green-400">EGP ${escapeHTML(project.priceEGP)}</p>`;
                    }
                    if (project.priceUSD) {
                        priceHTML += `<p class="text-lg font-medium text-gray-700 dark:text-gray-300">($${escapeHTML(project.priceUSD)} USD)</p>`;
                    }
                    if (!priceHTML) {
                        priceHTML = '<p class="text-lg font-medium text-gray-500">Price not set</p>';
                    }
                    
                    const dateHTML = project.date ? `<p><strong>Date:</strong> ${escapeHTML(formatDateDDMMYYYY(project.date))}</p>` : ''; // Updated format

                    let urlButton = '';
                    if (project.url) {
                        let properUrl = project.url;
                        if (!properUrl.startsWith('http://') && !properUrl.startsWith('https://')) {
                            properUrl = 'https://' + properUrl;
                        }
                        const safeUrl = properUrl.replace(/"/g, '&quot;');
                        urlButton = `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="py-1 px-3 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition-all">View Project</a>`;
                    }
                    
                    const roleTag = project.roleType ? `<span class="py-1 px-3 rounded-full text-sm font-medium ${getRoleColor(project.roleType)}">${escapeHTML(project.roleType)}</span>` : '';

                    card.innerHTML = `
                        <div class="flex flex-wrap justify-between items-start gap-2 mb-2">
                            <div>
                                <h3 class="text-xl font-bold text-green-600 dark:text-green-400">${escapeHTML(project.name)}</h3>
                                ${clientHTML}
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 items-end sm:items-center">
                                ${roleTag}
                                <span class="py-1 px-3 rounded-full text-sm font-medium ${getProjectStatusColor(project.status)}">${escapeHTML(project.status)}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-600 dark:text-gray-400 mb-4">
                            ${dateHTML}
                        </div>
                        <div class="mb-4">
                            ${priceHTML}
                        </div>
                        ${notesHTML}
                        <div class="flex flex-wrap gap-3 items-center mt-4">
                            ${urlButton}
                            <button class="edit-project-btn py-1 px-3 bg-yellow-500 text-white rounded-md text-sm hover:bg-yellow-600 transition-all" data-id="${project.id}">Edit</button>
                            <button class="delete-project-btn py-1 px-3 bg-red-500 text-white rounded-md text-sm hover:bg-red-600 transition-all" data-id="${project.id}">Delete</button>
                        </div>
                    `;
                    portfolioList.appendChild(card);
                });
            };
            
            // --- Form & List Event Handlers ---

            // Job Form Submit (Save or Update)
            jobForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const apps = getApplications();
                const editId = editIdInput.value;
                const todayIso = getTodayIso();

                if (appDateInput.value && appDateInput.value > todayIso) {
                    alert('Application date cannot be in the future.');
                    return;
                }

                const newApp = {
                    id: editId || Date.now().toString(),
                    company: companyNameInput.value,
                    title: jobTitleInput.value,
                    appDate: appDateInput.value,
                    status: appStatusInput.value,
                    contactPerson: contactPersonInput.value,
                    contactEmail: contactEmailInput.value,
                    followUpDate: followUpDateInput.value,
                    source: sourceInput.value,
                    roleType: roleTypeInput.value,
                    jobUrl: jobUrlInput.value,
                    notes: notesInput.value,
                };

                if (editId) {
                    // Update existing
                    const appIndex = apps.findIndex(app => app.id === editId);
                    if (appIndex > -1) {
                        apps[appIndex] = newApp;
                    }
                } else {
                    // Add new
                    apps.push(newApp);
                }

                saveApplications(apps);
                renderApplications();
                resetForm();
                showPage('dashboard'); // Switch to dashboard after saving
            });

            // Clear Job Form Button
            const resetForm = () => {
                jobForm.reset();
                editIdInput.value = '';
                formTitle.textContent = 'Add New Application';
                saveBtn.textContent = 'Save Application';
                saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            };
            
            clearBtn.addEventListener('click', resetForm);

            // --- NEW Project Form Handlers ---
            projectForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const projects = getProjects();
                const editId = editProjectIdInput.value;
                const todayIso = getTodayIso();

                if (projectDateInput.value && projectDateInput.value > todayIso) {
                    alert('Project date cannot be in the future.');
                    return;
                }

                const newProject = {
                    id: editId || Date.now().toString(),
                    name: projectNameInput.value,
                    client: clientNameInput.value,
                    date: projectDateInput.value,
                    status: projectStatusInput.value,
                    priceEGP: projectPriceEgpInput.value, // Updated
                    priceUSD: projectPriceUsdInput.value, // Updated
                    roleType: projectRoleTypeInput.value,
                    url: projectUrlInput.value,
                    notes: projectNotesInput.value,
                };

                if (editId) {
                    const projectIndex = projects.findIndex(p => p.id === editId);
                    if (projectIndex > -1) {
                        projects[projectIndex] = newProject;
                    }
                } else {
                    projects.push(newProject);
                }

                saveProjects(projects);
                renderPortfolio();
                resetProjectForm();
                showPage('portfolio');
            });

            const resetProjectForm = () => {
                projectForm.reset();
                editProjectIdInput.value = '';
                projectFormTitle.textContent = 'Add New Project';
                projectSaveBtn.textContent = 'Save Project';
                projectSaveBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                projectSaveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            };

            projectClearBtn.addEventListener('click', resetProjectForm);

            // Job List Clicks (Edit & Delete) - Event Delegation
            applicationList.addEventListener('click', (e) => {
                const target = e.target;
                const apps = getApplications();

                // Delete
                if (target.classList.contains('delete-btn')) {
                    const id = target.dataset.id;
                    const confirmed = window.confirm('Delete this application? This cannot be undone.');
                    if (!confirmed) {
                        return;
                    }
                    const updatedApps = apps.filter(app => app.id !== id);
                    saveApplications(updatedApps);
                    renderApplications();
                }

                // Edit
                if (target.classList.contains('edit-btn')) {
                    const id = target.dataset.id;
                    const appToEdit = apps.find(app => app.id === id);
                    
                    if (appToEdit) {
                        // Populate form
                        editIdInput.value = appToEdit.id;
                        companyNameInput.value = appToEdit.company;
                        jobTitleInput.value = appToEdit.title;
                        appDateInput.value = appToEdit.appDate;
                        appStatusInput.value = appToEdit.status;
                        contactPersonInput.value = appToEdit.contactPerson;
                        contactEmailInput.value = appToEdit.contactEmail;
                        followUpDateInput.value = appToEdit.followUpDate;
                        sourceInput.value = appToEdit.source;
                        roleTypeInput.value = appToEdit.roleType;
                        jobUrlInput.value = appToEdit.jobUrl;
                        notesInput.value = appToEdit.notes;

                        // Update form UI
                        formTitle.textContent = 'Edit Application';
                        saveBtn.textContent = 'Update Application';
                        saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        
                        showPage('form'); // Switch to the form page
                    }
                }
            });

            // --- NEW Portfolio List Clicks (Edit & Delete) ---
            portfolioList.addEventListener('click', (e) => {
                const target = e.target;
                const projects = getProjects();

                // Delete
                if (target.classList.contains('delete-project-btn')) {
                    const id = target.dataset.id;
                    const confirmed = window.confirm('Delete this project? This cannot be undone.');
                    if (!confirmed) {
                        return;
                    }
                    const updatedProjects = projects.filter(p => p.id !== id);
                    saveProjects(updatedProjects);
                    renderPortfolio();
                }

                // Edit
                if (target.classList.contains('edit-project-btn')) {
                    const id = target.dataset.id;
                    const projectToEdit = projects.find(p => p.id === id);
                    
                    if (projectToEdit) {
                        // Populate form
                        editProjectIdInput.value = projectToEdit.id;
                        projectNameInput.value = projectToEdit.name;
                        clientNameInput.value = projectToEdit.client;
                        projectDateInput.value = projectToEdit.date;
                        projectStatusInput.value = projectToEdit.status;
                        projectPriceEgpInput.value = projectToEdit.priceEGP; // Updated
                        projectPriceUsdInput.value = projectToEdit.priceUSD; // Updated
                        projectRoleTypeInput.value = projectToEdit.roleType;
                        projectUrlInput.value = projectToEdit.url;
                        projectNotesInput.value = projectToEdit.notes;

                        // Update form UI
                        projectFormTitle.textContent = 'Edit Project';
                        projectSaveBtn.textContent = 'Update Project';
                        projectSaveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        projectSaveBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                        
                        showPage('project-form'); // Switch to the project form page
                    }
                }
            });

            // Job Dashboard Controls
            searchBar.addEventListener('input', renderApplications);
            filterStatusInput.addEventListener('change', renderApplications);
            sortByInput.addEventListener('change', renderApplications);
            if (filterDateStartInput) filterDateStartInput.addEventListener('change', renderApplications);
            if (filterDateEndInput) filterDateEndInput.addEventListener('change', renderApplications);

            // New Portfolio Dashboard Controls
            searchProjectBar.addEventListener('input', renderPortfolio);
            filterProjectStatusInput.addEventListener('change', renderPortfolio);
            sortProjectByInput.addEventListener('change', renderPortfolio);
            if (filterProjectDateStartInput) filterProjectDateStartInput.addEventListener('change', renderPortfolio);
            if (filterProjectDateEndInput) filterProjectDateEndInput.addEventListener('change', renderPortfolio);

            const handleAnalyticsFilterChange = () => {
                ensureChartJs().then(() => {
                    renderAnalytics();
                }).catch(() => {
                    // Error already logged inside ensureChartJs
                });
            };

            if (analyticsStartInput) analyticsStartInput.addEventListener('change', handleAnalyticsFilterChange);
            if (analyticsEndInput) analyticsEndInput.addEventListener('change', handleAnalyticsFilterChange);


            // --- Analytics Functions ---
            const renderAnalytics = () => {
                if (typeof Chart === 'undefined') {
                    return;
                }

                const apps = getApplications();
                const projects = getProjects();
                const { startDate, endDate, hasFilter, invalid } = getAnalyticsDateFilters();
                if (invalid) {
                    return;
                }

                const filteredApps = filterItemsByDateRange(apps, (app) => app.appDate, startDate, endDate, hasFilter);
                const filteredProjects = filterItemsByDateRange(projects, (project) => project.date, startDate, endDate, hasFilter);

                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#e5e7eb' : '#374151';
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

                // --- Summary Cards ---
                const totalApps = filteredApps.length;
                const activeProjects = filteredProjects.filter((p) => p.status === 'In Progress' || p.status === 'Planning').length;
                const totalIncomeUSD = filteredProjects
                    .filter((p) => p.status === 'Completed' && p.priceUSD)
                    .reduce((sum, p) => sum + (parseFloat(p.priceUSD) || 0), 0);
                const totalIncomeEGP = filteredProjects
                    .filter((p) => p.status === 'Completed' && p.priceEGP)
                    .reduce((sum, p) => sum + (parseFloat(p.priceEGP) || 0), 0);
                const offersCount = filteredApps.filter((app) => app.status === 'Offer' || app.status === 'Accepted').length;
                const conversionRate = totalApps ? Math.round((offersCount / totalApps) * 100) : 0;

                document.getElementById('summary-total-apps').textContent = totalApps;
                document.getElementById('summary-active-projects').textContent = activeProjects;
                document.getElementById('summary-total-income-egp').textContent = 'EGP ' + totalIncomeEGP.toLocaleString();
                document.getElementById('summary-total-income-usd').textContent = '$' + totalIncomeUSD.toFixed(2) + ' USD';
                if (summaryConversionRate) {
                    summaryConversionRate.textContent = `${conversionRate}%`;
                }
                if (summaryOfferCount) {
                    summaryOfferCount.textContent = `${offersCount} ${offersCount === 1 ? 'offer' : 'offers'}`;
                }

                // --- Job Application Data ---
                const statusCounts = {};
                filteredApps.forEach((app) => {
                    statusCounts[app.status] = (statusCounts[app.status] || 0) + 1;
                });
                const statusLabels = Object.keys(statusCounts);
                const statusData = Object.values(statusCounts);

                const sourceCounts = {};
                filteredApps.forEach((app) => {
                    if (app.source) {
                        sourceCounts[app.source] = (sourceCounts[app.source] || 0) + 1;
                    }
                });
                const sourceLabels = Object.keys(sourceCounts);
                const sourceData = Object.values(sourceCounts);

                const timeCounts = {};
                filteredApps.forEach((app) => {
                    if (app.appDate) {
                        const month = app.appDate.substring(0, 7);
                        timeCounts[month] = (timeCounts[month] || 0) + 1;
                    }
                });
                const sortedMonths = Object.keys(timeCounts).sort();
                const timeLabels = sortedMonths;
                const timeData = sortedMonths.map((month) => timeCounts[month]);

                // --- Freelance Project Data ---
                const incomeCounts = {};
                filteredProjects.forEach((project) => {
                    if (project.date && project.priceUSD && project.status === 'Completed') {
                        const month = project.date.substring(0, 7);
                        const price = parseFloat(project.priceUSD) || 0;
                        incomeCounts[month] = (incomeCounts[month] || 0) + price;
                    }
                });
                const sortedIncomeMonths = Object.keys(incomeCounts).sort();
                const incomeLabels = sortedIncomeMonths;
                const incomeData = sortedIncomeMonths.map((month) => incomeCounts[month]);

                const freelanceStatusCounts = {};
                filteredProjects.forEach((project) => {
                    freelanceStatusCounts[project.status] = (freelanceStatusCounts[project.status] || 0) + 1;
                });
                const freelanceStatusLabels = Object.keys(freelanceStatusCounts);
                const freelanceStatusData = Object.values(freelanceStatusCounts);

                const freelanceRoleCounts = {};
                filteredProjects.forEach((project) => {
                    const role = project.roleType || 'Other';
                    freelanceRoleCounts[role] = (freelanceRoleCounts[role] || 0) + 1;
                });
                const freelanceRoleLabels = Object.keys(freelanceRoleCounts);
                const freelanceRoleData = Object.values(freelanceRoleCounts);

                // --- Destroy Existing Charts ---
                if (statusChartInstance) statusChartInstance.destroy();
                if (sourceChartInstance) sourceChartInstance.destroy();
                if (timeChartInstance) timeChartInstance.destroy();
                if (freelanceIncomeChartInstance) freelanceIncomeChartInstance.destroy();
                if (freelanceStatusChartInstance) freelanceStatusChartInstance.destroy();
                if (freelanceRoleChartInstance) freelanceRoleChartInstance.destroy();

                // --- Render Job Charts ---
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                statusChartInstance = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            label: 'Applications',
                            data: statusData,
                            backgroundColor: [
                                '#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#6b7280',
                                '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'
                            ],
                            borderColor: isDark ? '#1f2937' : '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                    }
                });

                const sourceCtx = document.getElementById('sourceChart').getContext('2d');
                sourceChartInstance = new Chart(sourceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: sourceLabels,
                        datasets: [{
                            label: 'Applications',
                            data: sourceData,
                            backgroundColor: [
                                '#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#6b7280',
                                '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'
                            ],
                            borderColor: isDark ? '#1f2937' : '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                    }
                });

                const timeCtx = document.getElementById('timeChart').getContext('2d');
                timeChartInstance = new Chart(timeCtx, {
                    type: 'line',
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'Applications',
                            data: timeData,
                            fill: true,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: '#3b82f6',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { grid: { color: gridColor }, ticks: { color: textColor } },
                            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, precision: 0 } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                // --- Render Freelance Charts ---
                const freelanceIncomeCtx = document.getElementById('freelanceIncomeChart').getContext('2d');
                freelanceIncomeChartInstance = new Chart(freelanceIncomeCtx, {
                    type: 'line',
                    data: {
                        labels: incomeLabels,
                        datasets: [{
                            label: 'Income (USD)',
                            data: incomeData,
                            fill: true,
                            backgroundColor: 'rgba(22, 163, 74, 0.2)',
                            borderColor: '#16a34a',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { grid: { color: gridColor }, ticks: { color: textColor } },
                            y: {
                                beginAtZero: true,
                                grid: { color: gridColor },
                                ticks: {
                                    color: textColor,
                                    callback: (value) => '$' + value
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Income: $${context.parsed.y}`
                                }
                            }
                        }
                    }
                });

                const freelanceStatusCtx = document.getElementById('freelanceStatusChart').getContext('2d');
                freelanceStatusChartInstance = new Chart(freelanceStatusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: freelanceStatusLabels,
                        datasets: [{
                            label: 'Projects',
                            data: freelanceStatusData,
                            backgroundColor: ['#6b7280', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                            borderColor: isDark ? '#1f2937' : '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                    }
                });

                const freelanceRoleCtx = document.getElementById('freelanceRoleChart').getContext('2d');
                freelanceRoleChartInstance = new Chart(freelanceRoleCtx, {
                    type: 'doughnut',
                    data: {
                        labels: freelanceRoleLabels,
                        datasets: [{
                            label: 'Projects',
                            data: freelanceRoleData,
                            backgroundColor: [
                                '#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#6b7280',
                                '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'
                            ],
                            borderColor: isDark ? '#1f2937' : '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                    }
                });
            };

            // --- Initial Load ---
            showPage('dashboard'); // Start on the job dashboard page
        });
    </script>

</body>
</html>